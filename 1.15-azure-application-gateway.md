

# ðŸ”¹ Lab Exercise â€“ Azure Application Gateway with Two Web Servers**

**Goal:**

* Create **two Linux VMs** with Apache webserver + HTML.
* Create an **Application Gateway**.
* Add the VMs as **backend pool**.
* Generate a **PFX certificate** and upload it.
* Create another **HTTPS listener** with the certificate.


# Resource Naming Convention

- **Resource Group**: `<studentname-rg>`
- **Virtual Machines**: `<studentname-vm1>` & `<studentname-vm2>`
- **Virtual Network (VNet)**: `<studentname-vnet>`
- **Subnets**: 
  - `frontend-subnet`
  - `backend-subnet`
- **Application Gateway**: `<studentname-appgw>`
- **Public IP**: `<studentname-appgw-pip>`
---

## **Step 1 â€“ Create Resource Group**

1. Go to **Azure Portal** â†’ Search for **Resource Groups** â†’ **Create**.
2. Name: `<studentname-rg>`
3. Region: `East US` (or your preferred).
4. Click **Review + Create** â†’ **Create**.

---

## **Step 2 â€“ Create Virtual Network and Subnets**

1. Search **Virtual Networks** â†’ **Create**.
2. Name: `<studentname-vnet>`.
3. Resource Group: `<studentname-rg>`.
4. Address space: `10.0.0.0/16`.
5. Add **subnets**:

   * `frontend-subnet` â†’ `10.0.1.0/24`
   * `backend-subnet` â†’ `10.0.2.0/24`
6. **Review + Create** â†’ **Create**.

---

## **Step 3 â€“ Create Two Linux VMs (Webservers)**

1. Search **Virtual Machines** â†’ **Create**.
2. Resource Group: `<studentname-rg>`.
3. Name: `<studentname-vm1>`.
4. Image: **Ubuntu Server LTS**.
5. Authentication: **Password or SSH key**.
6. Networking â†’ Attach to **backend-subnet** of `<studentname-vnet>`.
7. Public IP: **Yes** (so you can SSH).
8. **Review + Create** â†’ **Create**.

âž¡ Repeat for `<studentname-vm2>`.

---

## **Step 4 â€“ Install Apache + Custom HTML**

1. SSH into **VM1** (using public IP). Run:

   ```bash
   sudo apt update -y
   sudo apt install apache2 -y
   echo "<h1>Hello from VM1</h1>" | sudo tee /var/www/html/index.html
   ```
2. SSH into **VM2**. Run:

   ```bash
   sudo apt update -y
   sudo apt install apache2 -y
   echo "<h1>Hello from VM2</h1>" | sudo tee /var/www/html/index.html
   ```

---

## **Step 5 â€“ Create Application Gateway**

1. Search **Application Gateways** â†’ **Create**.
2. Resource Group: `<studentname-rg>`.
3. Name: `<studentname-appgw>`.
4. Region: Same as VNet.
5. Tier: **Standard\_v2**.
6. Virtual Network: `<studentname-vnet>`.

   * Subnet: **frontend-subnet**.
7. Frontend IP: Create new **Public IP** (`<studentname-appgw-pip>`).
8. Listener: Add **HTTP (port 80)** listener.
9. Backend Pool: Leave blank for now (weâ€™ll add VMs next).
10. **Review + Create** â†’ **Create**.

---

## **Step 6 â€“ Add Backend Pool (VMs)**

1. Open `<studentname-appgw>` in portal.
2. Go to **Backend pools** â†’ **+ Add**.
3. Name: `web-backend-pool`.
4. **Add targets** â†’ choose **Virtual machine** â†’ select `<studentname-vm1>` and `<studentname-vm2>`.
5. Save.

---

## **Step 7 â€“ Configure HTTP Settings & Routing Rule**

1. Go to **HTTP settings** â†’ **+ Add**.

   * Name: `web-http-settings`.
   * Port: `80`.
   * Protocol: `HTTP`.
   * Cookie-based affinity: Disabled.
   * Save.
2. Go to **Rules** â†’ **+ Basic Rule**.

   * Listener: `appGatewayHttpListener`.
   * Backend target: `web-backend-pool`.
   * HTTP settings: `web-http-settings`.
   * Save.

âœ… Now HTTP (port 80) traffic should load balance across VM1 & VM2.

---

## **Step 8 â€“ Create Self-Signed PFX Certificate**

On your local **Linux/Mac/WSL** system:

```bash
openssl req -x509 -newkey rsa:2048 -nodes -keyout appgw.key -out appgw.crt -days 365 -subj "/CN=appgw.demo.local"
openssl pkcs12 -export -out appgw.pfx -inkey appgw.key -in appgw.crt -password pass:P@ssw0rd!
```

---

## **Step 9 â€“ Create HTTPS Listener**

1. Open `<studentname-appgw>`.
2. Go to **SSL certificates** â†’ **+ Add**.

   * Name: `web-cert`.
   * Upload `appgw.pfx`.
   * Password: `P@ssw0rd!`.
   * Save.
3. Go to **Listeners** â†’ **+ Add listener**.

   * Name: `https-listener`.
   * Frontend port: `443`.
   * Protocol: HTTPS.
   * SSL certificate: `web-cert`.
   * Save.
4. Go to **Rules** â†’ **+ Basic Rule**.

   * Listener: `https-listener`.
   * Backend pool: `web-backend-pool`.
   * HTTP settings: `web-http-settings`.
   * Save.

---

## âœ… Final Result

* **HTTP (80)** and **HTTPS (443)** listeners both forward traffic to your **2 VM webservers**.
* HTTPS is secured with your **self-signed PFX cert**.

---

ðŸ‘‰ Do you want me to also prepare a **draw\.io diagram** for this setup (App Gateway + VMs + cert + listeners) so you can use it in your presentation?
