
---

# 🧪 **Lab Exercise: Azure VM Disk Encryption (PMK → CMK)**

### 🎯 **Objective**

You will:

1. Create a Resource Group, Virtual Network, and Subnet
2. Create a VM with SSE using PMK (default)
3. Create a Key Vault and assign yourself proper role access
4. Create a Key in Key Vault
5. Create a Disk Encryption Set (DES) and assign its role
6. Change VM Disk Encryption from PMK → CMK

---

## 🔹 **Naming Convention**

Use your name in the resource names. Example:

| Resource            | Name                 |
| ------------------- | -------------------- |
| Resource Group      | `studentname-rg`     |
| Virtual Network     | `studentname-vnet`   |
| Subnet              | `studentname-subnet` |
| Virtual Machine     | `studentname-vm`     |
| Key Vault           | `studentname-kv`     |
| Key                 | `studentname-key`    |
| Disk Encryption Set | `studentname-des`    |

*(Example: saravana-rg, saravana-vnet, saravana-vm, etc.)*

---

## 🪣 **Step 1: Create Resource Group**

1. Go to **Azure Portal → Resource groups → + Create**
2. Enter:

   * **Subscription:** (your subscription)
   * **Resource group:** `studentname-rg`
   * **Region:** (e.g., East US)
3. Click **Review + Create → Create**

---

## 🌐 **Step 2: Create Virtual Network and Subnet**

1. Go to **Virtual networks → + Create**
2. Enter:

   * **Resource Group:** `studentname-rg`
   * **Name:** `studentname-vnet`
   * **Region:** same as resource group
3. In **IP Addresses**, set:

   * **Address space:** `10.0.0.0/16`
4. Click **+ Add subnet**:

   * **Subnet name:** `studentname-subnet`
   * **Subnet address range:** `10.0.1.0/24`
   * Click **Add**
5. Click **Review + Create → Create**

---

## 💻 **Step 3: Create Azure VM (Default Encryption with PMK)**

1. Go to **Virtual Machines → + Create → Azure Virtual Machine**
2. Under **Basics**:

   * **Resource Group:** `studentname-rg`
   * **VM name:** `studentname-vm`
   * **Region:** same as RG
   * **Image:** Ubuntu Server 22.04 LTS (or Windows Server 2022)
   * **Size:** *Standard_B2s* (for testing)
3. **Administrator account:**

   * Username: `azureuser`
   * Authentication: Password or SSH key
4. **Networking:**

   * **Virtual Network:** `studentname-vnet`
   * **Subnet:** `studentname-subnet`
5. Go to **Disks** tab:

   * **Encryption type:** *Encryption at rest with platform-managed key* (default)
6. Click **Review + Create → Create**

🟢 **VM is now running with SSE using PMK (default).**

---

## 🔐 **Step 4: Create Key Vault**

1. Go to **Key Vaults → + Create**
2. Enter:

   * **Resource Group:** `studentname-rg`
   * **Key Vault name:** `studentname-kv`
   * **Region:** same as VM
3. Under **Access configuration**, select:

   * **Permission model:** *Azure role-based access control (RBAC)*
4. Enable **Soft delete** and **Purge protection**
5. Click **Review + Create → Create**

---

## 🧑‍💼 **Step 5: Assign Key Vault Role to Yourself**

1. After Key Vault is created, go to:
   **studentname-kv → Access Control (IAM) → + Add role assignment**
2. Choose:

   * **Role:** `Key Vault Administrator`
   * **Assign access to:** User, group, or service principal
   * **Select:** your Azure user account
3. Click **Save**

🟢 You can now manage keys, secrets, and permissions in the vault.

---

## 🗝️ **Step 6: Create Key inside Key Vault**

1. Open **studentname-kv → Objects → Keys → + Generate/Import**
2. Choose:

   * **Options:** Generate
   * **Name:** `studentname-key`
   * **Key type:** RSA
   * **Key size:** 2048
   * **Key operations:** Encrypt, Decrypt, Wrap Key, Unwrap Key
3. Click **Create**

🟢 Your CMK (Customer Managed Key) is now ready.

---

## 💽 **Step 7: Create Disk Encryption Set (DES)**

1. Go to **Create a resource → Search “Disk Encryption Set” → Create**
2. Fill in:

   * **Resource Group:** `studentname-rg`
   * **Name:** `studentname-des`
   * **Region:** same as Key Vault
3. Under **Encryption type:**

   * Select *Encryption at rest with customer-managed key*
   * **Key Vault:** `studentname-kv`
   * **Key:** `studentname-key`
4. Click **Review + Create → Create**

🟢 The DES will automatically create a **managed identity**.

---

## 🔑 **Step 8: Assign DES Access to Key Vault**

1. Go to **studentname-kv → Access Control (IAM) → + Add role assignment**
2. Choose:

   * **Role:** `Key Vault Crypto Service Encryption User`
   * **Assign access to:** Managed identity
   * **Select:** `studentname-des`
3. Click **Save**

🟢 This gives the DES permission to use the key for encryption and decryption.

---

## 💿 **Step 9: Change VM Disk Encryption (PMK → CMK)**

1. Go to **Virtual Machines → studentname-vm → Disks**
2. Click on the **OS Disk name** (e.g., `studentname-vm_disk1_xxxxx`)
3. Go to **Configuration** tab
4. Under **Encryption type**, select:

   * *Encryption at rest with customer-managed key*
5. Under **Disk Encryption Set**, choose: `studentname-des`
6. Click **Save**

🟢 Azure updates disk encryption in the background 
---

## 🔎 **Step 10: Verify Encryption**

1. Go to **studentname-vm → Disks → OS Disk → Encryption**
2. Confirm:

   * **Encryption type:** *Server-side encryption with customer-managed key*
   * **Disk Encryption Set:** `studentname-des`
   * **Key Vault:** `studentname-kv`

---

## 🧩 **Summary**

| Step | Action                  | Resource            | Example Name                              |
| ---- | ----------------------- | ------------------- | ----------------------------------------- |
| 1    | Create Resource Group   | Resource Group      | `studentname-rg`                          |
| 2    | Create Network          | VNet/Subnet         | `studentname-vnet` / `studentname-subnet` |
| 3    | Create VM               | Virtual Machine     | `studentname-vm`                          |
| 4    | Create Key Vault        | Key Vault           | `studentname-kv`                          |
| 5    | Assign Role to Yourself | IAM Role            | Key Vault Administrator                   |
| 6    | Create Key              | Key Vault Key       | `studentname-key`                         |
| 7    | Create DES              | Disk Encryption Set | `studentname-des`                         |
| 8    | Assign Role to DES      | IAM Role            | Key Vault Crypto Service Encryption User  |
| 9    | Change Encryption       | VM Disk             | PMK → CMK                                 |
| 10   | Verify                  | Portal              | Confirm CMK active                        |

---

## 🧠 **Key Takeaways**

* **SSE with PMK** = Azure manages encryption keys.
* **SSE with CMK** = You manage encryption keys via Key Vault.
* **DES** links the disk to your CMK key.
* Changing PMK → CMK happens **online, no VM downtime**.

---
