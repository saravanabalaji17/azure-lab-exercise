
---

# **Azure Lab Exercise: Azure AD User, Subscription Owner, VM with Azure AD Login**

---

## **Scenario**

* Create a new Azure AD user.
* Give the user **Owner** role at the subscription level.
* Create a Linux VM with **Azure AD login**.
* Attempt login **without assigning a VM role** (should fail).
* Assign VM role using **GUI and CLI**.
* Login successfully using Azure AD credentials.

---

## **Step 1: Create a User in Azure AD**

### **GUI Method**

1. Azure Portal → **Azure Active Directory → Users → New user → Create user**
2. Enter:

   * Name: `LabUser1`
   * Username: `labuser1@<tenant>.onmicrosoft.com`
   * Password: Auto-generate
3. Click **Create**

---

### **CLI Method**

```bash
az ad user create \
  --display-name "Lab User 1" \
  --user-principal-name labuser1@<tenant>.onmicrosoft.com \
  --password "P@ssword123!" \
  --force-change-password-next-login true
```

---

## **Step 2: Assign Owner Role at Subscription Level**

### **GUI Method**

1. Azure Portal → **Subscriptions → Select your subscription → Access control (IAM) → Add role assignment**
2. Role: **Owner**
3. Assign access to: **User, group, or service principal**
4. Select the newly created user → **Save**

---

### **CLI Method**

```bash
az role assignment create \
  --assignee labuser1@<tenant>.onmicrosoft.com \
  --role Owner \
  --scope /subscriptions/<subscription-id>
```

---

## **Step 3: Create Linux VM with Azure AD Login**

### **GUI Method**

1. Azure Portal → **Virtual Machines → Create → Azure VM**
2. Basics:

   * Resource Group: `LabRG`
   * VM Name: `LabVM01`
   * Image: Ubuntu 24.04 LTS
   * Size: Standard (e.g., B2s)
   * Authentication type: **Azure AD Login**
3. Networking: Allow **SSH (22)** inbound
4. Review + Create

---

### **CLI Method**

```bash
az vm create \
  --resource-group LabRG \
  --name LabVM01 \
  --image UbuntuLTS \
  --size Standard_B2s \
  --admin-type AADLogin \
  --location eastus \
  --generate-ssh-keys
```

> **Note:** The VM is created, but **no VM role assigned yet**, so login will fail initially.

---

## **Step 4: Attempt Login (Without VM Role)**

```bash
az login
az account set --subscription "<Subscription Name or ID>"

az ssh vm -g LabRG --ip <VM_PUBLIC_IP>
```

* You should see **permission denied** because the user does not have a VM login role.

---

## **Step 5: Assign VM Role (Allow Login)**

### **GUI Method**

1. Azure Portal → **LabVM01 → Access control (IAM) → Add role assignment**
2. Role options:

   * **Virtual Machine Administrator Login** → Full admin access
   * **Virtual Machine User Login** → Normal user access
3. Assign to **labuser1@<tenant>.onmicrosoft.com** → **Save**

---

### **CLI Method**

```bash
az role assignment create \
  --assignee labuser1@<tenant>.onmicrosoft.com \
  --role "Virtual Machine Administrator Login" \
  --scope /subscriptions/<subscription-id>/resourceGroups/LabRG/providers/Microsoft.Compute/virtualMachines/LabVM01
```

---

## **Step 6: Login to VM (After Role Assignment)**

```bash
az ssh vm -g LabRG --ip <VM_PUBLIC_IP>
```

* The login should now succeed.
* Verify by creating a test file:

```bash
touch ~/testfile.txt
ls -l ~/testfile.txt
```

---

## **Step 7: Verification**

* Check role assignments:

```bash
az role assignment list \
  --assignee labuser1@<tenant>.onmicrosoft.com \
  --scope /subscriptions/<subscription-id>/resourceGroups/LabRG/providers/Microsoft.Compute/virtualMachines/LabVM01
```

* Ensure the user has **Owner** at subscription level and **VM Administrator/User Login** on VM.

---

✅ **Lab Outcome**

1. User has **subscription owner access** but cannot SSH into VM without VM role.
2. After adding **VM login role**, SSH access works.
3. Both **GUI and CLI methods** demonstrated.

---
